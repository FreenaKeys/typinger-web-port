<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typinger - „Çø„Ç§„Éî„É≥„Ç∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Typinger</h1>
            <p class="subtitle">WebÁâà „Çø„Ç§„Éî„É≥„Ç∞Á∑¥Áøí„ÇΩ„Éï„Éà</p>
        </header>

        <main>
            <!-- „Çø„Ç§„Éî„É≥„Ç∞ÁîªÈù¢ -->
            <section id="typing-screen" class="screen active">
                <div class="typing-container">
                    <!-- ÁõÆÊ®ô„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫ -->
                    <div class="target-text-box">
                        <p class="label">ÁõÆÊ®ô„ÉÜ„Ç≠„Çπ„Éà</p>
                        <p id="target-text" class="target-text">{{ target_text }}</p>
                    </div>

                    <!-- „É´„ÉìÔºà„É≠„Éº„ÉûÂ≠óÔºâË°®Á§∫ -->
                    <div class="rubi-box">
                        <p class="label">„É≠„Éº„ÉûÂ≠óÂÖ•Âäõ</p>
                        <p id="rubi-remaining" class="rubi-remaining">{{ target_rubi }}</p>
                    </div>

                    <!-- ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ -->
                    <div class="input-box">
                        <input type="text" id="typing-input" class="typing-input" placeholder="„Åì„Åì„Å´ÂÖ•Âäõ„Åó„Åæ„Åô" autofocus>
                    </div>

                    <!-- Áµ±Ë®àÊÉÖÂ†± -->
                    <div class="stats-box">
                        <table class="stats-table">
                            <tr>
                                <td>Ê≠£Ëß£:</td>
                                <td id="stat-correct">0</td>
                                <td>„Éü„Çπ:</td>
                                <td id="stat-errors">0</td>
                            </tr>
                            <tr>
                                <td>ÊàêÂäüÁéá:</td>
                                <td id="stat-accuracy">0%</td>
                                <td>ÁµåÈÅéÊôÇÈñì:</td>
                                <td id="stat-time">0s</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
                    <div class="button-box">
                        <button id="btn-finish" class="btn btn-primary">ÂÆå‰∫Ü</button>
                        <button id="btn-escape" class="btn btn-secondary">‰∏≠Ê≠¢</button>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Typinger WebÁâà - „Ç™„Éº„Éó„É≥„ÇΩ„Éº„Çπ „Çø„Ç§„Éî„É≥„Ç∞Á∑¥Áøí„ÇΩ„Éï„Éà</p>
        </footer>
    </div>

    <script>
        // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±
        const SESSION_ID = '{{ session_id }}';
        const TARGET_TEXT = '{{ target_text }}';
        const TARGET_RUBI = '{{ target_rubi }}';

        console.log('üé¨ Typing page loaded');
        console.log('  Session ID:', SESSION_ID);
        console.log('  Target:', TARGET_TEXT);

        // „Çø„Ç§„Éî„É≥„Ç∞ÂÖ•ÂäõÂá¶ÁêÜ
        document.getElementById('typing-input').addEventListener('keydown', async (e) => {
            const char = e.key;

            // BackspaceÂá¶ÁêÜ
            if (e.key === 'Backspace') {
                e.preventDefault();
                const input = document.getElementById('typing-input');
                input.value = input.value.slice(0, -1);
                return;
            }

            // Âà∂Âæ°ÊñáÂ≠ó„ÅØÁÑ°Ë¶ñ
            if (e.ctrlKey || e.altKey || e.metaKey) return;

            try {
                const response = await fetch(`/api/session/${SESSION_ID}/judge_char`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ char: char, timestamp: Date.now() })
                });
                const data = await response.json();
                console.log('Judge result:', data);
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // ÂÆå‰∫Ü„Éú„Çø„É≥
        document.getElementById('btn-finish').addEventListener('click', async () => {
            const response = await fetch(`/api/session/${SESSION_ID}/finish`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.ok) {
                window.location.href = '/';
            }
        });

        // ‰∏≠Ê≠¢„Éú„Çø„É≥
        document.getElementById('btn-escape').addEventListener('click', () => {
            window.location.href = '/';
        });
    </script>
</body>
</html>
