<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typinger - „Çø„Ç§„Éî„É≥„Ç∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Typinger</h1>
            <p class="subtitle">WebÁâà „Çø„Ç§„Éî„É≥„Ç∞Á∑¥Áøí„ÇΩ„Éï„Éà</p>
        </header>

        <main>
            <!-- „Çø„Ç§„Éî„É≥„Ç∞ÁîªÈù¢ -->
            <section id="typing-screen" class="screen active">
                <div class="typing-container">
                    <!-- „Ç≠„Éº„Éû„ÉÉ„ÉóË®≠ÂÆö + „Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞„Éó„É¨„Éì„É•„Éº -->
                    <div class="keymap-setting" style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                            <div style="flex: 1;">
                                <label for="keymap-select" style="display: block; margin-bottom: 10px; font-weight: bold;">
                                    ‚å®Ô∏è „Ç≠„Éº„Éú„Éº„ÉâÈÖçÂàó:
                                </label>
                                <select id="keymap-select" style="width: 100%; padding: 8px; font-size: 14px; border-radius: 4px;">
                                    <option value="jis">JISÈÖçÂàó (Êó•Êú¨Ë™û)</option>
                                    <option value="ansi">ANSIÈÖçÂàó</option>
                                    <option value="dvorak">DvorakÈÖçÂàó</option>
                                </select>
                                <p id="keymap-info" style="margin-top: 10px; font-size: 12px; color: #666;">„Éá„Éï„Ç©„É´„Éà: JISÈÖçÂàó</p>
                            </div>
                            <!-- „Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞„Éó„É¨„Éì„É•„Éº -->
                            <div id="custom-mapping-preview" style="flex: 0 0 auto; padding: 10px; background: white; border-radius: 4px; border: 1px solid #bdc3c7; min-width: 250px; max-width: 400px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <p style="margin: 0; font-size: 11px; font-weight: bold; color: #2c3e50;">üéØ „Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞</p>
                                    <button id="btn-toggle-mappings" style="padding: 3px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                        Â±ïÈñã
                                    </button>
                                </div>
                                <div id="preview-mappings-summary" style="font-size: 11px; color: #7f8c8d; margin-bottom: 8px;">
                                    <!-- „Çµ„Éû„É™„ÉºË°®Á§∫ -->
                                </div>
                                <div id="preview-mappings-detail" style="display: none; max-height: 300px; overflow-y: auto; margin-top: 10px;">
                                    <!-- Ë©≥Á¥∞„Éû„ÉÉ„Éî„É≥„Ç∞‰∏ÄË¶ß -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫Ôºà„Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞Ë¶ñË¶öÂåñÔºâ -->
                    <div id="keyboard-display-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                        <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 14px;">‚å®Ô∏è „Ç≠„Éº„Éú„Éº„ÉâÈÖçÁΩÆ („Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞)</h3>
                        <div id="keyboard-layout" style="display: flex; flex-direction: column; gap: 8px; font-family: 'Arial', sans-serif; background: #2c3e50; padding: 20px; border-radius: 8px;">
                            <!-- F„Ç≠„ÉºË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">Esc</span>
                                <span style="flex: 0.3;"></span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F1</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F2</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F3</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F4</span>
                                <span style="flex: 0.3;"></span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F5</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F6</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F7</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F8</span>
                                <span style="flex: 0.3;"></span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F9</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F10</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F11</span>
                                <span style="background: #3498db; color: white; min-width: 40px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">F12</span>
                            </div>

                            <!-- Êï∞Â≠óË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span class="keyboard-key" data-key="`" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">`</span>
                                <span class="keyboard-key" data-key="1" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">1</span>
                                <span class="keyboard-key" data-key="2" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">2</span>
                                <span class="keyboard-key" data-key="3" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">3</span>
                                <span class="keyboard-key" data-key="4" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">4</span>
                                <span class="keyboard-key" data-key="5" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">5</span>
                                <span class="keyboard-key" data-key="6" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">6</span>
                                <span class="keyboard-key" data-key="7" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">7</span>
                                <span class="keyboard-key" data-key="8" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">8</span>
                                <span class="keyboard-key" data-key="9" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">9</span>
                                <span class="keyboard-key" data-key="0" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">0</span>
                                <span class="keyboard-key" data-key="-" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">-</span>
                                <span class="keyboard-key" data-key="=" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">=</span>
                                <span style="background: #3498db; color: white; min-width: 80px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Backspace</span>
                            </div>

                            <!-- QWERTYË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span style="background: #3498db; color: white; min-width: 60px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Tab</span>
                                <span class="keyboard-key" data-key="q" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Q</span>
                                <span class="keyboard-key" data-key="w" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">W</span>
                                <span class="keyboard-key" data-key="e" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">E</span>
                                <span class="keyboard-key" data-key="r" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">R</span>
                                <span class="keyboard-key" data-key="t" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">T</span>
                                <span class="keyboard-key" data-key="y" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Y</span>
                                <span class="keyboard-key" data-key="u" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">U</span>
                                <span class="keyboard-key" data-key="i" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">I</span>
                                <span class="keyboard-key" data-key="o" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">O</span>
                                <span class="keyboard-key" data-key="p" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">P</span>
                                <span class="keyboard-key" data-key="[" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">[</span>
                                <span class="keyboard-key" data-key="]" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">]</span>
                                <span class="keyboard-key" data-key="\\" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 60px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"></span>
                            </div>

                            <!-- ASDFË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span style="background: #e74c3c; color: white; min-width: 75px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Caps Lock</span>
                                <span class="keyboard-key" data-key="a" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">A</span>
                                <span class="keyboard-key" data-key="s" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">S</span>
                                <span class="keyboard-key" data-key="d" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">D</span>
                                <span class="keyboard-key" data-key="f" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">F</span>
                                <span class="keyboard-key" data-key="g" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">G</span>
                                <span class="keyboard-key" data-key="h" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">H</span>
                                <span class="keyboard-key" data-key="j" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">J</span>
                                <span class="keyboard-key" data-key="k" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">K</span>
                                <span class="keyboard-key" data-key="l" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">L</span>
                                <span class="keyboard-key" data-key=";" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">;</span>
                                <span class="keyboard-key" data-key="'" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">'</span>
                                <span style="background: #3498db; color: white; min-width: 110px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Enter</span>
                            </div>

                            <!-- ZXCVË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span style="background: #e74c3c; color: white; min-width: 90px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Shift</span>
                                <span class="keyboard-key" data-key="z" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Z</span>
                                <span class="keyboard-key" data-key="x" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">X</span>
                                <span class="keyboard-key" data-key="c" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">C</span>
                                <span class="keyboard-key" data-key="v" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">V</span>
                                <span class="keyboard-key" data-key="b" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">B</span>
                                <span class="keyboard-key" data-key="n" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">N</span>
                                <span class="keyboard-key" data-key="m" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">M</span>
                                <span class="keyboard-key" data-key="," style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">,</span>
                                <span class="keyboard-key" data-key="." style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">.</span>
                                <span class="keyboard-key" data-key="/" style="background: #ecf0f1; border: 2px solid #bdc3c7; border-radius: 4px; padding: 10px 8px; min-width: 40px; text-align: center; font-weight: bold; color: #2c3e50; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">/</span>
                                <span style="background: #e74c3c; color: white; min-width: 90px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Shift</span>
                            </div>

                            <!-- ‰øÆÈ£æ„Ç≠„ÉºË°å -->
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Ctrl</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Win</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Alt</span>
                                <span style="background: #34495e; color: white; flex: 1; min-width: 300px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Space</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Alt</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Win</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Menu</span>
                                <span style="background: #e74c3c; color: white; min-width: 50px; padding: 10px 8px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Ctrl</span>
                            </div>
                        </div>
                    </div>
                    <div class="target-text-box">
                        <p class="label">ÁõÆÊ®ô„ÉÜ„Ç≠„Çπ„Éà</p>
                        <p id="target-text" class="target-text">{{ target_text }}</p>
                    </div>

                    <!-- „É´„ÉìÔºà„É≠„Éº„ÉûÂ≠óÔºâË°®Á§∫ -->
                    <div class="rubi-box">
                        <p class="label">„É≠„Éº„ÉûÂ≠óÂÖ•Âäõ</p>
                        <p id="rubi-remaining" class="rubi-remaining" style="min-height: 30px;">{{ target_rubi }}</p>
                        <p id="rubi-progress" style="font-size: 12px; color: #e74c3c; margin-top: 5px;"></p>
                    </div>

                    <!-- ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ -->
                    <div class="input-box">
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ÁèæÂú®„ÅÆ„Ç≠„Éº„Éû„ÉÉ„Éó: <span id="current-keymap-display">JISÈÖçÂàó</span>
                        </p>
                        <input type="text" id="typing-input" class="typing-input" placeholder="„Åì„Åì„Å´ÂÖ•Âäõ„Åó„Åæ„Åô" autofocus>
                    </div>

                    <!-- Áµ±Ë®àÊÉÖÂ†± -->
                    <div class="stats-box">
                        <table class="stats-table">
                            <tr>
                                <td>Ê≠£Ëß£:</td>
                                <td id="stat-correct">0</td>
                                <td>„Éü„Çπ:</td>
                                <td id="stat-errors">0</td>
                            </tr>
                            <tr>
                                <td>ÊàêÂäüÁéá:</td>
                                <td id="stat-accuracy">0%</td>
                                <td>ÁµåÈÅéÊôÇÈñì:</td>
                                <td id="stat-time">0s</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
                    <div class="button-box">
                        <button id="btn-finish" class="btn btn-primary">ÂÆå‰∫Ü</button>
                        <button id="btn-escape" class="btn btn-secondary">‰∏≠Ê≠¢</button>
                    </div>
                </div>
            </section>

            <!-- ÁµêÊûúÁîªÈù¢ -->
            <section id="result-screen" class="screen hidden">
                <div class="typing-container">
                    <h2>ÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</h2>
                    <div class="result-box">
                        <table class="result-table">
                            <tr>
                                <td>Ê≠£Ëß£Êï∞:</td>
                                <td id="result-correct">0</td>
                            </tr>
                            <tr>
                                <td>„Éü„ÇπÊï∞:</td>
                                <td id="result-errors">0</td>
                            </tr>
                            <tr>
                                <td>ÊàêÂäüÁéá:</td>
                                <td id="result-accuracy">0%</td>
                            </tr>
                            <tr>
                                <td>ÊâÄË¶ÅÊôÇÈñì:</td>
                                <td id="result-duration">0Áßí</td>
                            </tr>
                        </table>
                    </div>
                    <div class="button-box">
                        <button id="btn-home" class="btn btn-primary">„Éõ„Éº„É†„Å´Êàª„Çã</button>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Typinger WebÁâà - „Ç™„Éº„Éó„É≥„ÇΩ„Éº„Çπ „Çø„Ç§„Éî„É≥„Ç∞Á∑¥Áøí„ÇΩ„Éï„Éà</p>
        </footer>
    </div>

    <script>
        // ========== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ==========
        const SESSION_ID = '{{ session_id }}';
        const TARGET_TEXT = '{{ target_text }}';
        const TARGET_RUBI = '{{ target_rubi }}';
        
        let startTime = Date.now();
        let correct = 0;
        let errors = 0;
        let currentProgress = '';
        let currentKeymap = 'jis';
        let keymapData = null;
        let editingKey = null;
        let editingValue = null;

        console.log('üé¨ Typing page loaded');
        console.log('  Session ID:', SESSION_ID);
        console.log('  Target Text:', TARGET_TEXT);
        console.log('  Target Rubi:', TARGET_RUBI);

        // ========== „Ç≠„Éº„Éû„ÉÉ„ÉóÂá¶ÁêÜ ==========
        async function loadKeymap(preset) {
            try {
                console.log(`‚å®Ô∏è Loading keymap: ${preset}`);
                
                // „Éó„É™„Çª„ÉÉ„Éà„Åã„Ç´„Çπ„Çø„É†„Åã„ÇíÂà§ÂÆö
                let response;
                if (['jis', 'ansi', 'dvorak'].includes(preset)) {
                    response = await fetch(`/api/keymap/presets/${preset}`);
                } else {
                    // „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„ÉóÔºà.json„Å™„Åó„ÅßÈÄÅ‰ø°Ôºâ
                    response = await fetch(`/api/keymap/${preset}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    keymapData = data.keymap;
                    
                    // mappings „Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                    if (!keymapData.mappings) {
                        keymapData.mappings = {};
                    }
                    
                    currentKeymap = preset;
                    
                    const presetNames = {
                        'jis': 'JISÈÖçÂàó (Êó•Êú¨Ë™û)',
                        'ansi': 'ANSIÈÖçÂàó',
                        'dvorak': 'DvorakÈÖçÂàó'
                    };
                    
                    const displayName = presetNames[preset] || preset;
                    const mappingCount = Object.keys(keymapData.mappings).length;
                    if (mappingCount > 0) {
                        document.getElementById('keymap-info').textContent = `‚úÖ ‰ΩøÁî®‰∏≠: ${displayName} (${mappingCount}ÂÄã„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞)`;
                    } else {
                        document.getElementById('keymap-info').textContent = `‚úÖ ‰ΩøÁî®‰∏≠: ${displayName}`;
                    }
                    console.log(`‚úÖ Keymap loaded: ${preset}`, keymapData);
                } else {
                    console.error('‚ùå Failed to load keymap:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Error loading keymap:', error);
            }
        }

        // „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó„Çí„Çª„É¨„ÇØ„Éà„Å´ËøΩÂä†
        async function loadCustomKeymaps() {
            try {
                console.log('üìÇ Loading custom keymaps...');
                const response = await fetch('/api/keymap/list');
                const data = await response.json();
                
                if (data.ok && data.keymaps) {
                    const customKeymaps = data.keymaps.filter(km => 
                        km !== 'jis.json' && km !== 'ansi.json' && km !== 'dvorak.json'
                    );
                    
                    if (customKeymaps.length > 0) {
                        const select = document.getElementById('keymap-select');
                        
                        // „Äå„Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†
                        let hasCustomGroup = false;
                        for (let option of select.options) {
                            if (option.textContent === '--- „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó ---') {
                                hasCustomGroup = true;
                                break;
                            }
                        }
                        
                        if (!hasCustomGroup && customKeymaps.length > 0) {
                            // „Ç∞„É´„Éº„Éó„Çª„Éë„É¨„Éº„Çø
                            const separator = document.createElement('option');
                            separator.textContent = '--- „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó ---';
                            separator.disabled = true;
                            select.appendChild(separator);
                        }
                        
                        // „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó„ÇíËøΩÂä†
                        customKeymaps.forEach(km => {
                            const keymapName = km.replace('.json', '');
                            const option = document.createElement('option');
                            option.value = keymapName;
                            option.textContent = `üìå ${keymapName}`;
                            select.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Loaded ${customKeymaps.length} custom keymaps`);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No custom keymaps available');
                }
            } catch (error) {
                console.error('‚ùå Error loading custom keymaps:', error);
            }
        }

        // „Ç≠„Éº„Éû„ÉÉ„ÉóÈÅ∏Êäû„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
        document.getElementById('keymap-select').addEventListener('change', (e) => {
            const preset = e.target.value;
            loadKeymap(preset);
            
            // sessionStorage „Å´‰øùÂ≠ò
            safeSetStorage('selectedKeymap', preset);
            console.log('üíæ Keymap saved to storage:', preset);
            
            const presetNames = {
                'jis': 'JISÈÖçÂàó',
                'ansi': 'ANSIÈÖçÂàó',
                'dvorak': 'DvorakÈÖçÂàó'
            };
            document.getElementById('current-keymap-display').textContent = presetNames[preset] || preset;
            
            // „Éû„ÉÉ„Éî„É≥„Ç∞„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
            setTimeout(() => {
                updateMappingPreview();
                updateKeyboardDisplay();
            }, 100);
        });

        // ========== „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫Êõ¥Êñ∞ ==========
        function updateKeyboardDisplay() {
            const keyboardSection = document.getElementById('keyboard-display-section');
            
            // „Éû„ÉÉ„Éî„É≥„Ç∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫
            if (!keymapData || !keymapData.mappings || Object.keys(keymapData.mappings).length === 0) {
                keyboardSection.style.display = 'none';
                return;
            }
            
            keyboardSection.style.display = 'block';
            
            // „Åô„Åπ„Å¶„ÅÆ„Ç≠„Éº„Éú„Éº„Éâ„Ç≠„Éº„ÇíÊõ¥Êñ∞
            const keyElements = document.querySelectorAll('.keyboard-key');
            keyElements.forEach(keyElement => {
                const keyValue = keyElement.getAttribute('data-key');
                
                if (keymapData.mappings[keyValue]) {
                    // „Éû„ÉÉ„Éî„É≥„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈªÑËâ≤„Å´„Åó„Å¶„ÄÅ„Éû„ÉÉ„ÉóÂÖà„ÇíË°®Á§∫
                    const mappedChar = keymapData.mappings[keyValue];
                    keyElement.textContent = mappedChar.toUpperCase();
                    keyElement.style.background = '#ffc107';
                    keyElement.style.color = '#000';
                    keyElement.title = `${keyValue} ‚Üí ${mappedChar}`;
                } else {
                    // „Éû„ÉÉ„Éî„É≥„Ç∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖÉ„ÅÆË°®Á§∫„Å´Êàª„Åô
                    const originalChars = {
                        '`': '`', '1': '1', '2': '2', '3': '3', '4': '4', '5': '5',
                        '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                        '-': '-', '=': '=',
                        'q': 'Q', 'w': 'W', 'e': 'E', 'r': 'R', 't': 'T',
                        'y': 'Y', 'u': 'U', 'i': 'I', 'o': 'O', 'p': 'P',
                        '[': '[', ']': ']', '\\': '\\',
                        'a': 'A', 's': 'S', 'd': 'D', 'f': 'F', 'g': 'G',
                        'h': 'H', 'j': 'J', 'k': 'K', 'l': 'L', ';': ';', "'": "'",
                        'z': 'Z', 'x': 'X', 'c': 'C', 'v': 'V', 'b': 'B',
                        'n': 'N', 'm': 'M', ',': ',', '.': '.', '/': '/'
                    };
                    keyElement.textContent = originalChars[keyValue] || keyValue;
                    keyElement.style.background = '#ecf0f1';
                    keyElement.style.color = '#2c3e50';
                    keyElement.title = '';
                }
            });
            
            console.log('‚úÖ Keyboard display updated');
        }

        // ========== „Çπ„Éà„É¨„Éº„Ç∏„Ç¢„ÇØ„Çª„ÇπÈñ¢Êï∞Ôºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç®„É©„ÉºÂØæÂøúÔºâ==========
        function safeGetStorage(key, defaultValue = null) {
            try {
                return sessionStorage.getItem(key) || defaultValue;
            } catch (error) {
                console.warn(`‚ö†Ô∏è sessionStorage access denied: ${error.message}, using default`);
                return defaultValue;
            }
        }

        function safeSetStorage(key, value) {
            try {
                sessionStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.warn(`‚ö†Ô∏è sessionStorage write denied: ${error.message}`);
                return false;
            }
        }

        // ÂàùÊúü„Ç≠„Éº„Éû„ÉÉ„ÉóË™≠„ÅøËæº„Åø
        loadKeymap('jis');
        
        // „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó„Çí„Çª„É¨„ÇØ„Éà„Å´ËøΩÂä†
        loadCustomKeymaps();
        
        // „Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ keymap „ÇíË™≠„ÅøËæº„Åø
        const savedKeymap = safeGetStorage('selectedKeymap');
        if (savedKeymap) {
            console.log('üíæ Loading saved keymap:', savedKeymap);
            // setTimeout „Åß keymapData „ÅåÊ∫ñÂÇô„Åß„Åç„Çã„Åæ„ÅßÂæÖ„Å§
            setTimeout(() => {
                loadKeymap(savedKeymap);
                document.getElementById('keymap-select').value = savedKeymap;
                updateMappingPreview();
            }, 200);
        }
        
        // „Ç´„Çπ„Çø„É†„Ç≠„Éº„Éû„ÉÉ„Éó„Éá„Éº„ÇøÂæ©ÂÖÉ
        const savedKeymapData = safeGetStorage('currentKeymapData');
        if (savedKeymapData) {
            try {
                const parsed = JSON.parse(savedKeymapData);
                console.log('üíæ Restored keymap data:', parsed);
                
                if (parsed.mappings && Object.keys(parsed.mappings).length > 0) {
                    // keymapData „ÇíÂÆåÂÖ®„Å´ÁΩÆ„ÅçÊèõ„Åà„Çã
                    if (!keymapData) {
                        keymapData = { version: 1, keys: [], mappings: {} };
                    }
                    keymapData.mappings = { ...parsed.mappings };
                    console.log('‚úÖ Applied mappings:', keymapData.mappings);
                    updateMappingPreview();
                    updateKeyboardDisplay();
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Failed to restore keymap data:', e);
            }
        }
        
        // keymapData „ÅÆÁ¢∫Ë™ç
        console.log('üìä Initial keymapData:', keymapData);

        // ========== „Ç´„Çπ„Çø„É†„Éû„ÉÉ„Éî„É≥„Ç∞„Éó„É¨„Éì„É•„ÉºÂá¶ÁêÜ ==========
        let mappingsExpanded = false;
        
        function updateMappingPreview() {
            const preview = document.getElementById('custom-mapping-preview');
            
            // keymapData „ÅÆÁ¢∫Ë™ç
            if (!keymapData) {
                console.warn('‚ö†Ô∏è keymapData is not initialized in updateMappingPreview');
                preview.style.display = 'none';
                return;
            }
            
            if (!keymapData.mappings) {
                keymapData.mappings = {};
            }
            
            const mappings = keymapData.mappings;
            const mappingCount = Object.keys(mappings).length;
            
            console.log(`üéØ updateMappingPreview called - ${mappingCount} mappings`);
            console.log('   Mappings:', mappings);
            
            if (mappingCount > 0) {
                console.log('‚úÖ Showing preview (has mappings)');
                preview.style.display = 'block';
                
                // „Çµ„Éû„É™„ÉºË°®Á§∫
                const summaryEl = document.getElementById('preview-mappings-summary');
                summaryEl.textContent = `${mappingCount}ÂÄã„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞`;
                
                // Ë©≥Á¥∞„É™„Çπ„ÉàÁîüÊàê
                const detailEl = document.getElementById('preview-mappings-detail');
                detailEl.innerHTML = Object.entries(mappings)
                    .map(([from, to]) => `
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 3px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1; cursor: pointer;" onclick="window.editMappingValueInline('${from}', '${to}')">
                                <span style="font-weight: bold; font-size: 12px;">${from}</span>
                                <span style="color: #95a5a6; margin: 0 5px;">‚Üí</span>
                                <span style="color: #27ae60; font-weight: bold; font-size: 12px; text-decoration: underline;">${to}</span>
                            </div>
                            <button onclick="window.removeMappingInline('${from}')" style="padding: 2px 6px; background: #e74c3c; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 10px;">
                                ÂâäÈô§
                            </button>
                        </div>
                    `).join('');
                
            } else {
                preview.style.display = 'none';
            }
            
            // „Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫„ÇíÊõ¥Êñ∞
            updateKeyboardDisplay();
        }
        
        // Â±ïÈñã/Êäò„Çä„Åü„Åü„Åø„Éà„Ç∞„É´
        function toggleMappingsDetail() {
            mappingsExpanded = !mappingsExpanded;
            const detailEl = document.getElementById('preview-mappings-detail');
            const btnEl = document.getElementById('btn-toggle-mappings');
            
            if (mappingsExpanded) {
                detailEl.style.display = 'block';
                btnEl.textContent = 'ÊäòÁï≥';
            } else {
                detailEl.style.display = 'none';
                btnEl.textContent = 'Â±ïÈñã';
            }
        }
        
        // „Ç§„É≥„É©„Ç§„É≥„Åß„Éû„ÉÉ„Éî„É≥„Ç∞Á∑®ÈõÜ
        function editMappingValueInline(from, to) {
            if (!keymapData) {
                console.error('‚ùå keymapData is not initialized');
                alert('„Ç≠„Éº„Éû„ÉÉ„Éó„Éá„Éº„Çø„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            editingKey = from;
            editingValue = to;
            console.log(`‚úèÔ∏è Editing mapping inline: ${from} ‚Üí ${to}`);
            
            const detailEl = document.getElementById('preview-mappings-detail');
            const tempHtml = detailEl.innerHTML;
            
            detailEl.innerHTML = `
                <div style="background: #fff3cd; padding: 12px; border-radius: 4px; border: 2px solid #f39c12; text-align: center;">
                    <p style="margin: 0 0 8px 0; font-weight: bold; color: #f39c12; font-size: 11px;">‚å®Ô∏è "${from}" „ÅÆÊñ∞„Åó„ÅÑÂÄ§„ÇíÂÖ•Âäõ...</p>
                    <p style="margin: 0; font-size: 10px; color: #7f8c8d;">„Ç≠„Éº„Éú„Éº„Éâ„ÅÆ„Ç≠„Éº„Çí1„Å§Êäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            `;
            
            // „Çø„Ç§„Éî„É≥„Ç∞ÂÖ•Âäõ„Çí„Éñ„É©„Éº
            const typingInput = document.getElementById('typing-input');
            if (typingInput) typingInput.blur();
            
            let handled = false;
            const handler = (e) => {
                if (handled) return;
                
                if (e.ctrlKey || e.altKey || e.metaKey) return;
                
                if (e.key === 'Escape') {
                    handled = true;
                    detailEl.innerHTML = tempHtml;
                    document.removeEventListener('keydown', handler, true);
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                handled = true;
                
                const newValue = e.key;
                console.log(`‚úÖ New value: "${newValue}"`);
                
                if (!keymapData.mappings) keymapData.mappings = {};
                keymapData.mappings[from] = newValue;
                
                console.log('‚úÖ Mapping updated:', keymapData.mappings);
                updateMappingPreview();
                
                document.removeEventListener('keydown', handler, true);
            };
            
            document.addEventListener('keydown', handler, true);
        }
        
        // „Ç§„É≥„É©„Ç§„É≥„Åß„Éû„ÉÉ„Éî„É≥„Ç∞ÂâäÈô§
        function removeMappingInline(key) {
            console.log(`üóëÔ∏è Removing mapping inline: "${key}"`);
            delete keymapData.mappings[key];
            updateMappingPreview();
            console.log('‚úÖ Removed mapping:', key);
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        const btnToggle = document.getElementById('btn-toggle-mappings');
        console.log('üîç btn-toggle-mappings element:', btnToggle);
        if (btnToggle) {
            btnToggle.addEventListener('click', () => {
                console.log('üñ±Ô∏è Toggle button clicked!');
                toggleMappingsDetail();
            });
            console.log('‚úÖ Toggle button event listener registered');
        } else {
            console.error('‚ùå btn-toggle-mappings element NOT FOUND!');
        }

        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´Èñ¢Êï∞„ÇíÁôªÈå≤Ôºàonclick „Åã„ÇâÂëº„Å≥Âá∫„ÅóÂèØËÉΩ„Å´„Åô„ÇãÔºâ
        window.editMappingValueInline = editMappingValueInline;
        window.removeMappingInline = removeMappingInline;
        window.toggleMappingsDetail = toggleMappingsDetail;
        console.log('‚úÖ Global functions registered:', {
            editMappingValueInline: typeof window.editMappingValueInline,
            removeMappingInline: typeof window.removeMappingInline,
            toggleMappingsDetail: typeof window.toggleMappingsDetail
        });

        console.log('  Target Rubi:', TARGET_RUBI);

        // ========== UIÊõ¥Êñ∞Èñ¢Êï∞ ==========
        function updateStats() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const total = correct + errors;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            document.getElementById('stat-correct').textContent = correct;
            document.getElementById('stat-errors').textContent = errors;
            document.getElementById('stat-accuracy').textContent = accuracy + '%';
            document.getElementById('stat-time').textContent = elapsed + 's';
        }

        function showResultScreen(result) {
            console.log('üìä Showing result screen:', result);
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const accuracy = result.accuracy || 0;

            document.getElementById('result-correct').textContent = result.correct || 0;
            document.getElementById('result-errors').textContent = result.errors || 0;
            document.getElementById('result-accuracy').textContent = accuracy + '%';
            document.getElementById('result-duration').textContent = elapsed + 'Áßí';

            // ÁîªÈù¢Âàá„ÇäÊõø„Åà
            document.getElementById('typing-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
        }

        // ========== „Ç≠„ÉºÂÖ•ÂäõÂá¶ÁêÜ ==========
        // ========== „Ç≠„Éº„Éû„ÉÉ„Éî„É≥„Ç∞Âá¶ÁêÜ ==========
        function applyKeyMapping(inputChar) {
            /**
             * „Ç≠„Éº„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÈÅ©Áî®
             * - currentKeymap „Å´ mappings „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
             * - „Å™„ÅÑÂ†¥Âêà„ÅØÂÖÉ„ÅÆÊñáÂ≠ó„ÇíËøî„Åô
             */
            if (!keymapData || !keymapData.mappings) {
                return inputChar;
            }

            const mappedChar = keymapData.mappings[inputChar];
            if (mappedChar) {
                console.log(`üîÑ Keymap applied: ${inputChar} ‚Üí ${mappedChar}`);
                return mappedChar;
            }

            return inputChar;
        }

        document.getElementById('typing-input').addEventListener('keydown', async (e) => {
            let char = e.key;
            const input = document.getElementById('typing-input');

            // BackspaceÂá¶ÁêÜ
            if (e.key === 'Backspace') {
                e.preventDefault();
                input.value = input.value.slice(0, -1);
                return;
            }

            // Enter„Ç≠„Éº„ÅßÂÆå‰∫Ü
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('‚úÖ Enter pressed - finishing session');
                finishSession();
                return;
            }

            // Âà∂Âæ°ÊñáÂ≠ó„ÅØÁÑ°Ë¶ñ
            if (e.ctrlKey || e.altKey || e.metaKey) return;

            // „Ç≠„Éº„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÈÅ©Áî®
            const mappedChar = applyKeyMapping(char);
            
            // ÈÄöÂ∏∏„ÅÆ„Ç≠„ÉºÂÖ•Âäõ
            console.log(`‚å®Ô∏è Key pressed: ${char}${char !== mappedChar ? ` (mapped: ${mappedChar})` : ''}`);

            try {
                const timestamp = Date.now() - startTime;
                const response = await fetch(`/api/session/${SESSION_ID}/judge_char`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        char: mappedChar,  // „Éû„ÉÉ„Éó„Åï„Çå„ÅüÊñáÂ≠ó„ÇíÈÄÅ‰ø°
                        timestamp: timestamp,
                        keymap: currentKeymap
                    })
                });

                if (!response.ok) {
                    console.error('‚ùå API error:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('üìã Judge result:', data);

                if (data.ok) {
                    // ÁµêÊûú„ÇíÂèçÊò†
                    if (data.result === 'correct') {
                        correct++;
                        console.log('‚úÖ Correct! Total:', correct);
                    } else {
                        errors++;
                        console.log('‚ùå Error! Total:', errors);
                    }

                    // UIÊõ¥Êñ∞
                    updateStats();

                    // ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                    if (data.finished) {
                        console.log('üéâ Session finished!');
                        showResultScreen(data);
                    } else if (data.progress !== undefined) {
                        // ÈÄ≤ÊçóÊõ¥Êñ∞
                        let remainingRubi = '';
                        if (typeof data.progress === 'string') {
                            remainingRubi = data.progress;
                        } else if (data.progress.remaining_rubi !== undefined) {
                            remainingRubi = data.progress.remaining_rubi;
                        }
                        
                        currentProgress = remainingRubi;
                        document.getElementById('rubi-remaining').textContent = remainingRubi;
                        
                        const completedCount = TARGET_RUBI.length - remainingRubi.length;
                        document.getElementById('rubi-progress').textContent = `‚úÖ ÂÖ•ÂäõÊ∏à„Åø: ${completedCount} ÊñáÂ≠ó`;
                        console.log('üìç Progress:', remainingRubi, `(Completed: ${completedCount}/${TARGET_RUBI.length})`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
            }
        });

        // ========== „Éú„Çø„É≥Âá¶ÁêÜ ==========
        async function finishSession() {
            try {
                const response = await fetch(`/api/session/${SESSION_ID}/finish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                console.log('‚úÖ Finish response:', data);

                if (data.ok) {
                    showResultScreen(data);
                }
            } catch (error) {
                console.error('‚ùå Finish error:', error);
            }
        }

        document.getElementById('btn-finish').addEventListener('click', () => {
            console.log('üî¥ Finish button clicked');
            finishSession();
        });

        document.getElementById('btn-escape').addEventListener('click', () => {
            console.log('üî¥ Escape button clicked');
            if (confirm('„Çø„Ç§„Éî„É≥„Ç∞„Çí‰∏≠Ê≠¢„Åó„Åæ„Åô„ÅãÔºü')) {
                window.location.href = '/';
            }
        });

        document.getElementById('btn-home').addEventListener('click', () => {
            console.log('üî¥ Home button clicked');
            window.location.href = '/';
        });

        // ÂàùÊúüË°®Á§∫
        console.log('‚úÖ Typing page initialized');
    </script>
</body>
</html>

