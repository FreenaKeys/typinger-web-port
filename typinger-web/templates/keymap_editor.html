<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…ç½® - Typinger</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .keyboard-container {
            max-width: 1200px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .keyboard-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .keyboard-title h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .keyboard-layout {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Arial', sans-serif;
            background: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }

        .key-row {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .key {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            padding: 12px 8px;
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            cursor: default;
        }

        .key:hover {
            background: #fff;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .key-special {
            background: #3498db;
            color: white;
            min-width: 60px;
        }

        .key-modifier {
            background: #e74c3c;
            color: white;
            min-width: 70px;
        }

        .key-space {
            flex: 1;
            min-width: 300px;
            background: #34495e;
            color: white;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .info-label {
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }

        .info-value {
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…ç½®</h1>
                <nav class="header-links">
                    <a href="/">ğŸ¯ ãƒ›ãƒ¼ãƒ </a>
                    <a href="/editor" class="active">âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</a>
                </nav>
            </div>
        </header>

        <main>
            <div class="keyboard-container">
                <div class="keyboard-title">
                    <h2>æ¨™æº–ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…ç½®</h2>
                    <p>ä¸€èˆ¬çš„ãªQWERTYé…åˆ—ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã™</p>
                </div>

                <!-- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤º -->
                <div class="keyboard-layout">
                    <!-- ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ¼è¡Œ -->
                    <div class="key-row">
                        <span class="key key-special">Esc</span>
                        <span style="flex: 0.5;"></span>
                        <span class="key key-special">F1</span>
                        <span class="key key-special">F2</span>
                        <span class="key key-special">F3</span>
                        <span class="key key-special">F4</span>
                        <span style="flex: 0.3;"></span>
                        <span class="key key-special">F5</span>
                        <span class="key key-special">F6</span>
                        <span class="key key-special">F7</span>
                        <span class="key key-special">F8</span>
                        <span style="flex: 0.3;"></span>
                        <span class="key key-special">F9</span>
                        <span class="key key-special">F10</span>
                        <span class="key key-special">F11</span>
                        <span class="key key-special">F12</span>
                    </div>

                    <!-- æ•°å­—è¡Œ -->
                    <div class="key-row">
                        <span class="key">`</span>
                        <span class="key">1</span>
                        <span class="key">2</span>
                        <span class="key">3</span>
                        <span class="key">4</span>
                        <span class="key">5</span>
                        <span class="key">6</span>
                        <span class="key">7</span>
                        <span class="key">8</span>
                        <span class="key">9</span>
                        <span class="key">0</span>
                        <span class="key">-</span>
                        <span class="key">=</span>
                        <span class="key key-special" style="min-width: 80px;">Backspace</span>
                    </div>

                    <!-- QWERTYè¡Œ -->
                    <div class="key-row">
                        <span class="key key-special" style="min-width: 60px;">Tab</span>
                        <span class="key">Q</span>
                        <span class="key">W</span>
                        <span class="key">E</span>
                        <span class="key">R</span>
                        <span class="key">T</span>
                        <span class="key">Y</span>
                        <span class="key">U</span>
                        <span class="key">I</span>
                        <span class="key">O</span>
                        <span class="key">P</span>
                        <span class="key">[</span>
                        <span class="key">]</span>
                        <span class="key key-special" style="min-width: 60px;">\</span>
                    </div>

                    <!-- ASDFè¡Œ -->
                    <div class="key-row">
                        <span class="key key-modifier" style="min-width: 75px;">Caps Lock</span>
                        <span class="key">A</span>
                        <span class="key">S</span>
                        <span class="key">D</span>
                        <span class="key">F</span>
                        <span class="key">G</span>
                        <span class="key">H</span>
                        <span class="key">J</span>
                        <span class="key">K</span>
                        <span class="key">L</span>
                        <span class="key">;</span>
                        <span class="key">'</span>
                        <span class="key key-special" style="min-width: 110px;">Enter</span>
                    </div>

                    <!-- ZXCVè¡Œ -->
                    <div class="key-row">
                        <span class="key key-modifier" style="min-width: 90px;">Shift</span>
                        <span class="key">Z</span>
                        <span class="key">X</span>
                        <span class="key">C</span>
                        <span class="key">V</span>
                        <span class="key">B</span>
                        <span class="key">N</span>
                        <span class="key">M</span>
                        <span class="key">,</span>
                        <span class="key">.</span>
                        <span class="key">/</span>
                        <span class="key key-modifier" style="min-width: 90px;">Shift</span>
                    </div>

                    <!-- ä¿®é£¾ã‚­ãƒ¼è¡Œ -->
                    <div class="key-row">
                        <span class="key key-modifier">Ctrl</span>
                        <span class="key key-modifier">Win</span>
                        <span class="key key-modifier">Alt</span>
                        <span class="key key-space">Space</span>
                        <span class="key key-modifier">Alt</span>
                        <span class="key key-modifier">Win</span>
                        <span class="key key-modifier">Menu</span>
                        <span class="key key-modifier">Ctrl</span>
                    </div>
                </div>

                <!-- æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="info-section">
                    <h3>ğŸ“‹ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æƒ…å ±</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">é…åˆ—ã‚¿ã‚¤ãƒ—</span>
                            <span class="info-value">QWERTYï¼ˆæ—¥æœ¬èªJISé…åˆ—å¯¾å¿œï¼‰</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã‚­ãƒ¼æ•°</span>
                            <span class="info-value">ç´„109ã‚­ãƒ¼ï¼ˆJISæ¨™æº–ï¼‰</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¨€èªå¯¾å¿œ</span>
                            <span class="info-value">æ—¥æœ¬èªã€è‹±èª</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</span>
                            <span class="info-value">ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã§è‡ªå‹•é©ç”¨</span>
                        </div>
                    </div>
                </div>

                <!-- èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ -->
                <div class="info-section" style="margin-top: 20px; background: #e8f4f8; border-left: 4px solid #3498db;">
                    <h3>ğŸ’¡ ã”åˆ©ç”¨ã‚¬ã‚¤ãƒ‰</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #2c3e50; line-height: 1.8;">
                        <li>ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…ç½®ã‚’ç¢ºèªã§ãã¾ã™</li>
                        <li>ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚’ä½œæˆãƒ»ç·¨é›†ã™ã‚‹ã«ã¯ã€ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç”»é¢ã§ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚»ãƒ¬ã‚¯ãƒˆã‹ã‚‰ã€Œã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒãƒƒãƒ—ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</li>
                        <li>ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§å€‹åˆ¥ã®ã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã§ãã¾ã™</li>
                        <li>è¨­å®šã—ãŸã‚­ãƒ¼ãƒãƒƒãƒ—ã¯ã‚¿ã‚¤ãƒ”ãƒ³ã‚°æ™‚ã«è‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™</li>
                    </ul>
                </div>

                <!-- ã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãƒ‘ãƒãƒ« -->
                <div class="info-section" style="margin-top: 30px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3>ğŸ”„ ã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š</h3>
                    <p style="font-size: 13px; color: #333; margin-bottom: 15px;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’åˆ¥ã®ã‚­ãƒ¼ã«ç½®æ›ã—ã¾ã™ã€‚ä¸‹ã®ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <!-- å…ƒã®ã‚­ãƒ¼é¸æŠ -->
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 8px;">ğŸ“ å…ƒã®ã‚­ãƒ¼:</label>
                            <div id="source-key-display" style="background: white; border: 3px solid #3498db; padding: 20px; text-align: center; border-radius: 4px; min-height: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 18px; transition: all 0.3s ease;">
                                <span style="color: #999;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</span>
                            </div>
                            <p style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                        </div>

                        <!-- çŸ¢å° -->
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: bold; color: #3498db;">â‡’</div>
                            <button id="btn-clear-mapping" style="margin-top: 10px; padding: 8px 12px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                        </div>

                        <!-- å¤‰æ›´å…ˆã®ã‚­ãƒ¼é¸æŠ -->
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 8px;">ğŸ¯ å¤‰æ›´å…ˆã®ã‚­ãƒ¼:</label>
                            <div id="target-key-display" style="background: white; border: 3px solid #2ecc71; padding: 20px; text-align: center; border-radius: 4px; min-height: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 18px; transition: all 0.3s ease;">
                                <span style="color: #999;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</span>
                            </div>
                            <p style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <button id="btn-add-mapping" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">âœ… ã“ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ </button>
                    </div>

                    <!-- ãƒãƒƒãƒ”ãƒ³ã‚°ä¸€è¦§ -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“‹ ç¾åœ¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°:</h4>
                        <div id="mappings-list" style="background: white; padding: 10px; border-radius: 4px; min-height: 50px; max-height: 200px; overflow-y: auto;">
                            <p style="color: #999; text-align: center;">ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>

                    <!-- ã‚­ãƒ¼ãƒãƒƒãƒ—åã¨ä¿å­˜ -->
                    <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 8px;">ğŸ’¾ ã‚­ãƒ¼ãƒãƒƒãƒ—å:</label>
                            <input type="text" id="keymap-name" placeholder="my_keymap" style="width: 100%; padding: 10px; border: 2px solid #bdc3c7; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 5px; align-items: flex-end;">
                            <button id="btn-save-keymap" style="flex: 1; padding: 10px 15px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ’¾ ä¿å­˜</button>
                            <button id="btn-load-keymap" style="flex: 1; padding: 10px 15px; background: #2980b9; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
                        </div>
                    </div>

                    <!-- ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒãƒƒãƒ—ä¸€è¦§ -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“š ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒãƒƒãƒ—:</h4>
                        <div id="saved-keymaps-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; text-align: center; color: #999;">
                                èª­ã¿è¾¼ã¿ä¸­...
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
                    <div id="message-area" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </main>

        <footer>
            <p>Typinger Webç‰ˆ - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…ç½®è¡¨</p>
        </footer>
    </div>

    <script>
        console.log('âœ… Keyboard editor page loaded');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let mappingMode = null;
        let sourceKeyValue = null;
        let targetKeyValue = null;
        let currentMappings = {};
        let isAwaitingKey = false;  // ã‚­ãƒ¼å…¥åŠ›å¾…æ©Ÿä¸­ãƒ•ãƒ©ã‚°

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('message-area');
            if (!messageArea) {
                console.error('âŒ message-area element not found');
                return;
            }
            messageArea.textContent = text;
            messageArea.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
            messageArea.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
            messageArea.style.display = 'block';
            console.log(`[${type.toUpperCase()}] ${text}`);
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 3000);
        }

        // ã‚­ãƒ¼ãƒãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadSavedKeymaps() {
            try {
                console.log('ğŸ“‚ Loading saved keymaps...');
                const response = await fetch('/api/keymap/list');
                const data = await response.json();

                const container = document.getElementById('saved-keymaps-list');
                if (!container) {
                    console.error('âŒ saved-keymaps-list element not found');
                    return;
                }
                
                if (!data.ok || !data.keymaps || data.keymaps.length === 0) {
                    container.innerHTML = '<div style="background: #f0f0f0; padding: 10px; border-radius: 4px; text-align: center; color: #999; grid-column: 1/-1;">ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                const customKeymaps = data.keymaps.filter(km => 
                    km !== 'jis.json' && km !== 'ansi.json' && km !== 'dvorak.json'
                );

                if (customKeymaps.length === 0) {
                    container.innerHTML = '<div style="background: #f0f0f0; padding: 10px; border-radius: 4px; text-align: center; color: #999; grid-column: 1/-1;">ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                container.innerHTML = customKeymaps.map(km => {
                    const name = km.replace('.json', '');
                    return `
                        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #2c3e50;">${name}</span>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="window.loadKeymap('${name}')" style="padding: 5px 10px; background: #2980b9; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">èª­è¾¼</button>
                                <button onclick="window.deleteKeymap('${name}')" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">å‰Šé™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log(`âœ… Loaded ${customKeymaps.length} keymaps`);
            } catch (error) {
                console.error('âŒ Error loading keymaps:', error);
                showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿
        async function loadKeymap(name) {
            try {
                console.log(`ğŸ“‚ Loading keymap: ${name}`);
                const response = await fetch(`/api/keymap/${name}.json`);
                const data = await response.json();

                if (data.keymap && data.keymap.mappings) {
                    currentMappings = data.keymap.mappings;
                    const nameInput = document.getElementById('keymap-name');
                    if (nameInput) nameInput.value = name;
                    updateMappingsList();
                    showMessage(`âœ… ã‚­ãƒ¼ãƒãƒƒãƒ— '${name}' ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('âŒ Error loading keymap:', error);
                showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚’å‰Šé™¤
        async function deleteKeymap(name) {
            if (!confirm(`'${name}' ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                console.log(`ğŸ—‘ï¸ Deleting keymap: ${name}`);
                const response = await fetch(`/api/keymap/${name}.json`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`âœ… ã‚­ãƒ¼ãƒãƒƒãƒ— '${name}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
                    loadSavedKeymaps();
                } else {
                    showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('âŒ Error deleting keymap:', error);
                showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // UI ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateMappingPreview() {
            if (sourceKeyValue && targetKeyValue) {
                console.log(`ğŸ“ Updating preview: ${sourceKeyValue} â†’ ${targetKeyValue}`);
                
                // è‡ªå‹•çš„ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
                currentMappings[sourceKeyValue] = targetKeyValue;
                console.log(`âœ… Auto-added mapping: "${sourceKeyValue}" â†’ "${targetKeyValue}"`);
                console.log(`   Updated currentMappings:`, currentMappings);
                
                // UIæ›´æ–°
                updateMappingsList();
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const successMsg = `ãƒãƒƒãƒ”ãƒ³ã‚° '${sourceKeyValue} â†’ ${targetKeyValue}' ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
                showMessage(successMsg, 'success');
                
                // æ¬¡ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                sourceKeyValue = null;
                targetKeyValue = null;
                clearMapping();
                console.log('ğŸ”„ Reset for next mapping');
            }
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°ä¸€è¦§ã‚’æ›´æ–°
        function updateMappingsList() {
            const mappingsList = document.getElementById('mappings-list');
            if (!mappingsList) {
                console.error('âŒ mappings-list element not found');
                return;
            }
            
            if (Object.keys(currentMappings).length === 0) {
                mappingsList.innerHTML = '<p style="color: #999; text-align: center;">ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            mappingsList.innerHTML = Object.entries(currentMappings).map(([from, to]) => `
                <div style="padding: 12px; margin: 8px 0; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #28a745;">
                    <span style="font-size: 14px;">
                        <span style="font-weight: bold; color: #2c3e50; font-size: 16px;">${from}</span>
                        <span style="color: #95a5a6; margin: 0 8px;">â†’</span>
                        <span style="color: #27ae60; font-weight: bold; font-size: 16px;">${to}</span>
                    </span>
                    <button onclick="window.removeMapping('${from}')" style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: bold;">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            `).join('');
            
            console.log(`ğŸ“‹ Updated mappings list: ${Object.keys(currentMappings).length} items`);
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°å‰Šé™¤
        function removeMapping(key) {
            console.log(`ğŸ—‘ï¸ Removing mapping: ${key}`);
            delete currentMappings[key];
            updateMappingsList();
            showMessage(`ãƒãƒƒãƒ”ãƒ³ã‚° '${key}' ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°è¿½åŠ 
        function addMapping() {
            console.log('ğŸ” addMapping called');
            console.log(`   sourceKeyValue: "${sourceKeyValue}"`);
            console.log(`   targetKeyValue: "${targetKeyValue}"`);
            console.log(`   currentMappings:`, currentMappings);
            
            if (!sourceKeyValue || !targetKeyValue) {
                console.error(`âŒ Cannot add mapping - source: "${sourceKeyValue}", target: "${targetKeyValue}"`);
                showMessage('å…ƒã®ã‚­ãƒ¼ã¨å¤‰æ›´å…ˆã®ã‚­ãƒ¼ã‚’ä¸¡æ–¹é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            currentMappings[sourceKeyValue] = targetKeyValue;
            console.log(`âœ… Mapping added: "${sourceKeyValue}" â†’ "${targetKeyValue}"`);
            console.log(`   Updated currentMappings:`, currentMappings);
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…ˆã«è¡¨ç¤ºï¼ˆclearMapping ã®å‰ã«ï¼ï¼‰
            const successMsg = `ãƒãƒƒãƒ”ãƒ³ã‚° '${sourceKeyValue} â†’ ${targetKeyValue}' ã‚’è¿½åŠ ã—ã¾ã—ãŸ`;
            showMessage(successMsg, 'success');
            
            updateMappingsList();
            clearMapping();
        }

        // ã‚­ãƒ¼ãƒãƒƒãƒ—ä¿å­˜
        async function saveKeymap() {
            const nameInput = document.getElementById('keymap-name');
            if (!nameInput) {
                console.error('âŒ keymap-name element not found');
                return;
            }
            
            const name = nameInput.value.trim();
            
            if (!name) {
                showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (Object.keys(currentMappings).length === 0) {
                showMessage('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                console.log(`ğŸ’¾ Saving keymap: ${name}`);
                const response = await fetch('/api/keymap/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: name,
                        keymap: {
                            version: 1,
                            keys: [],
                            mappings: currentMappings
                        }
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    showMessage(`âœ… ã‚­ãƒ¼ãƒãƒƒãƒ— '${name}' ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
                    loadSavedKeymaps();
                } else {
                    showMessage(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('âŒ Error saving keymap:', error);
                showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šã‚¯ãƒªã‚¢
        function clearMapping() {
            sourceKeyValue = null;
            targetKeyValue = null;
            
            const sourceDisplay = document.getElementById('source-key-display');
            const targetDisplay = document.getElementById('target-key-display');
            
            if (sourceDisplay) {
                sourceDisplay.innerHTML = '<span style="color: #999;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
                sourceDisplay.style.background = 'white';
            }
            if (targetDisplay) {
                targetDisplay.innerHTML = '<span style="color: #999;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</span>';
                targetDisplay.style.background = 'white';
            }
            mappingMode = null;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’ç™»éŒ²
        window.loadKeymap = loadKeymap;
        window.deleteKeymap = deleteKeymap;
        window.removeMapping = removeMapping;
        window.addMapping = addMapping;
        window.saveKeymap = saveKeymap;
        window.clearMapping = clearMapping;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²é–¢æ•°
        function setupAllEventListeners() {
            console.log('ğŸ”§ Setting up event listeners...');
            
            const sourceDisplay = document.getElementById('source-key-display');
            const targetDisplay = document.getElementById('target-key-display');
            const btnClear = document.getElementById('btn-clear-mapping');
            const btnAdd = document.getElementById('btn-add-mapping');
            const btnSave = document.getElementById('btn-save-keymap');
            const btnLoad = document.getElementById('btn-load-keymap');
            
            if (sourceDisplay) {
                sourceDisplay.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Source key display clicked');
                    mappingMode = 'source';
                    isAwaitingKey = true;
                    sourceDisplay.style.background = '#fff3cd';
                    sourceDisplay.style.borderColor = '#f39c12';
                    sourceDisplay.innerHTML = '<span style="color: #856404;">ğŸ”´ ã‚­ãƒ¼å…¥åŠ›å¾…æ©Ÿä¸­...</span>';
                    console.log('ğŸ“ Waiting for source key input...');
                });
                console.log('âœ… Source display listener attached');
            } else {
                console.error('âŒ source-key-display element not found');
            }

            if (targetDisplay) {
                targetDisplay.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Target key display clicked');
                    mappingMode = 'target';
                    targetDisplay.style.background = '#d1ecf1';
                    targetDisplay.innerHTML = '<span style="color: #0c5460;">ğŸ”´ ã‚­ãƒ¼å…¥åŠ›å¾…æ©Ÿä¸­...</span>';
                    console.log('ğŸ¯ Waiting for target key input...');
                });
                console.log('âœ… Target display listener attached');
            } else {
                console.error('âŒ target-key-display element not found');
            }

            if (btnClear) {
                btnClear.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Clear button clicked');
                    clearMapping();
                });
                console.log('âœ… Clear button listener attached');
            }

            if (btnAdd) {
                btnAdd.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Add mapping button clicked');
                    addMapping();
                });
                console.log('âœ… Add button listener attached');
            }

            if (btnSave) {
                btnSave.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Save keymap button clicked');
                    saveKeymap();
                });
                console.log('âœ… Save button listener attached');
            }

            if (btnLoad) {
                btnLoad.addEventListener('click', () => {
                    console.log('ğŸ–±ï¸ Load keymap button clicked');
                    const nameInput = document.getElementById('keymap-name');
                    const name = nameInput ? nameInput.value.trim() : '';
                    if (name) {
                        loadKeymap(name);
                    } else {
                        showMessage('ã‚­ãƒ¼ãƒãƒƒãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    }
                });
                console.log('âœ… Load button listener attached');
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼å…¥åŠ›ãƒªã‚¹ãƒŠãƒ¼
            document.addEventListener('keydown', (e) => {
                if (!isAwaitingKey || mappingMode !== 'target') return;
                
                console.log(`âŒ¨ï¸ Physical keyboard key pressed: ${e.key}`);
                
                // ç‰¹æ®Šã‚­ãƒ¼ã¯ç„¡è¦–
                if (e.key === 'Enter' || e.key === 'Tab' || e.key === 'Escape') {
                    return;
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Œå…¨ã«åœæ­¢
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const keyName = e.key;
                console.log(`âœ… Captured replacement key: "${keyName}" (code: ${e.code})`);
                
                // ç½®ãæ›ãˆå…ˆã‚­ãƒ¼ã¨ã—ã¦è¨­å®š
                targetKeyValue = keyName;
                const targetDisplay = document.getElementById('target-key-display');
                if (targetDisplay) {
                    targetDisplay.innerHTML = `<span style="color: #27ae60; font-weight: bold; font-size: 24px;">${keyName}</span>`;
                    targetDisplay.style.background = '#d4edda';
                    targetDisplay.style.borderColor = '#27ae60';
                }
                console.log(`âœ… Target key set to: "${keyName}"`);
                
                // ç”»é¢ä¸Šã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                const highlightedKeys = document.querySelectorAll('.key');
                highlightedKeys.forEach(key => {
                    if (key.style.background === 'rgb(255, 193, 7)' || key.style.boxShadow.includes('ff9800')) {
                        key.style.background = '';
                        key.style.boxShadow = '';
                    }
                });
                console.log('ğŸ”„ Cleared keyboard highlights');
                
                // UIæ›´æ–°ï¼šç½®ãæ›ãˆçµæœã‚’è¡¨ç¤º
                updateMappingPreview();
                
                // ã‚­ãƒ¼å…¥åŠ›å¾…æ©Ÿã‚’çµ‚äº†
                mappingMode = null;
                isAwaitingKey = false;
                console.log('âœ… Mapping ready for addition');
            }, true);

            console.log('âœ… All event listeners registered successfully');
        }

        // DOM èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºèª
        if (document.readyState === 'loading') {
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ä¸­
            console.log('ğŸ“„ Document is loading...');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('ğŸ¯ DOM Content Loaded');
                setupAllEventListeners();
                setupKeyboardClickListeners();
                loadSavedKeymaps();
                console.log('âœ… Initialization complete');
            });
        } else {
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†æ¸ˆã¿
            console.log('ğŸ“„ Document already loaded');
            setupAllEventListeners();
            setupKeyboardClickListeners();
            loadSavedKeymaps();
            console.log('âœ… Initialization complete');
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã®ã‚­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
        function setupKeyboardClickListeners() {
            console.log('âŒ¨ï¸ Setting up keyboard click listeners...');
            
            // ã™ã¹ã¦ã®ã‚­ãƒ¼è¦ç´ ã‚’å–å¾—
            const keys = document.querySelectorAll('.key');
            console.log(`Found ${keys.length} key elements`);
            
            keys.forEach(keyElement => {
                // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚­ãƒ¼åã‚’æŠ½å‡ºï¼ˆä¾‹: "A" â†’ "a"ï¼‰
                let keyText = keyElement.textContent.trim();
                
                // ç‰¹æ®Šã‚­ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (['Esc', 'Tab', 'Caps Lock', 'Shift', 'Ctrl', 'Win', 'Alt', 'Menu', 'Backspace', 'Enter', 'Space'].includes(keyText)) {
                    console.log(`â­ï¸ Skipping special key: ${keyText}`);
                    return;
                }
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                keyElement.style.cursor = 'pointer';
                keyElement.addEventListener('click', () => {
                    if (mappingMode !== null) {
                        console.warn('âš ï¸ Mapping already in progress');
                        return;
                    }
                    
                    // ã‚­ãƒ¼ã®å€¤ã‚’å–å¾—ï¼ˆå¤§æ–‡å­—â†’å°æ–‡å­—ã«çµ±ä¸€ï¼‰
                    const keyValue = keyText.toLowerCase();
                    console.log(`ğŸ–±ï¸ Keyboard key clicked: "${keyText}" (normalized: "${keyValue}")`);
                    
                    // å…ƒã®ã‚­ãƒ¼ã¨ã—ã¦è¨­å®š
                    sourceKeyValue = keyValue;
                    const sourceDisplay = document.getElementById('source-key-display');
                    if (sourceDisplay) {
                        sourceDisplay.innerHTML = `<span style="color: #27ae60; font-weight: bold; font-size: 24px;">${keyValue}</span>`;
                        sourceDisplay.style.background = '#d4edda';
                        sourceDisplay.style.borderColor = '#27ae60';
                    }
                    console.log(`âœ… Source key set: "${keyValue}"`);
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚­ãƒ¼ã‚’å¼·èª¿è¡¨ç¤º
                    keyElement.style.background = '#ffc107';
                    keyElement.style.boxShadow = '0 0 10px #ff9800';
                    
                    // ç½®ãæ›ãˆå…ˆã‚­ãƒ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«é·ç§»
                    console.log('ğŸ”„ Waiting for replacement key from physical keyboard...');
                    mappingMode = 'target';
                    isAwaitingKey = true;
                    const targetDisplay = document.getElementById('target-key-display');
                    if (targetDisplay) {
                        targetDisplay.style.background = '#fff3cd';
                        targetDisplay.style.borderColor = '#f39c12';
                        targetDisplay.innerHTML = '<span style="color: #856404;">ğŸ”´ ç½®ãæ›ãˆå…ˆã‚­ãƒ¼ã‚’å…¥åŠ›...</span>';
                    }
                    console.log('ğŸ¯ Ready for replacement key input from physical keyboard...');
                });
            });
            
            console.log('âœ… Keyboard click listeners setup complete');
        }
    </script>
</body>
</html>
